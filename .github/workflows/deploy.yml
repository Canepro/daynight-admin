# Deploy static site to AWS EC2 with nginx
# Trigger: push to main (change branch if needed)
# Required secrets: EC2_HOST, SSH_USER, SSH_PRIVATE_KEY

name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install nginx and prepare docroot on EC2
        env:
          SSH_AUTH_SOCK: ''
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new \
            "${{ secrets.SSH_USER }}@${{ secrets.EC2_HOST }}" \
            'sudo bash -s' << 'REMOTE'
            # Idempotent: install nginx (Ubuntu)
            if command -v nginx >/dev/null 2>&1; then
              echo "nginx already installed"
            else
              sudo apt-get update -qq && sudo apt-get install -y nginx
            fi
            sudo mkdir -p /var/www/html
            sudo chown -R $SUDO_USER:$SUDO_USER /var/www/html
            # Point default site to /var/www/html (Ubuntu uses /var/www/html by default; ensure it)
            if [ -f /etc/nginx/sites-available/default ]; then
              sudo sed -i 's|/usr/share/nginx/html|/var/www/html|g' /etc/nginx/sites-available/default
            fi
            if [ -f /etc/nginx/nginx.conf ]; then
              sudo sed -i 's|/usr/share/nginx/html|/var/www/html|g' /etc/nginx/nginx.conf
            fi
            sudo systemctl enable nginx
            sudo systemctl start nginx
          REMOTE

      - name: Deploy files to EC2
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            ./ "${{ secrets.SSH_USER }}@${{ secrets.EC2_HOST }}:/var/www/html/"

      - name: Reload nginx
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "${{ secrets.SSH_USER }}@${{ secrets.EC2_HOST }}" \
            'sudo systemctl reload nginx'